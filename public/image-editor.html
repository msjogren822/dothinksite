<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Image Editor with Gemini AI</title>
    <style>
        body {
            font-family: 'Google Sans', Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background: #f8f9fa;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .upload-area {
            border: 2px dashed #4285f4;
            border-radius: 8px;
            padding: 40px;
            text-align: center;
            margin: 20px 0;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .upload-area:hover {
            background: #f1f3f4;
        }
        .upload-area.dragover {
            border-color: #1a73e8;
            background: #e8f0fe;
        }
        .image-preview {
            max-width: 100%;
            max-height: 300px;
            margin: 10px 0;
            border-radius: 8px;
        }
        .button {
            background: #1a73e8;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            margin: 10px 5px;
        }
        .button:hover {
            background: #1557b0;
        }
        .button:disabled {
            background: #dadce0;
            cursor: not-allowed;
        }
        .prompt-input {
            width: 100%;
            padding: 12px;
            border: 1px solid #dadce0;
            border-radius: 6px;
            font-size: 14px;
            margin: 10px 0;
            min-height: 60px;
            resize: vertical;
        }
        .result-area {
            margin-top: 20px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
        }
        .loading {
            display: flex;
            align-items: center;
            gap: 10px;
            color: #5f6368;
        }
        .spinner {
            width: 20px;
            height: 20px;
            border: 2px solid #f3f3f3;
            border-top: 2px solid #4285f4;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .preset-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin: 15px 0;
        }
        .preset-button {
            background: #f1f3f4;
            color: #3c4043;
            border: 1px solid #dadce0;
            padding: 8px 16px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 13px;
        }
        .preset-button:hover {
            background: #e8eaed;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üé® Image Editor with Gemini AI</h1>
        <p>Upload a background and foreground image to blend them together with AI!</p>
        
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin: 20px 0;">
            <div>
                <h3>üì∑ Background Image</h3>
                <div class="upload-area" id="backgroundUploadArea">
                    <div>ÔøΩÔ∏è Drop background image here</div>
                    <input type="file" id="backgroundInput" accept="image/*" style="display: none;">
                </div>
                <div id="backgroundPreview"></div>
            </div>
            
            <div>
                <h3>üéØ Foreground Subject</h3>
                <div class="upload-area" id="foregroundUploadArea">
                    <div>üë§ Drop foreground subject here</div>
                    <input type="file" id="foregroundInput" accept="image/*" style="display: none;">
                </div>
                <div id="foregroundPreview"></div>
            </div>
        </div>
        
        <div>
            <h3>What would you like to do?</h3>
            <div class="preset-buttons">
                <button class="preset-button" onclick="setPrompt('Create a new image by combining the elements from the provided images. Take the dog from the second image and place it naturally into the scene from the first image. Ensure that the dog\'s features remain completely unchanged while blending seamlessly with the background lighting and atmosphere.')">Multi-Image Fusion</button>
                <button class="preset-button" onclick="setPrompt('Using the provided images, place the subject from the second image onto the scene from the first image. Ensure that the features of the subject from the second image remain completely unchanged. The added element should blend naturally with the lighting and style of the first image.')">Preserve Features</button>
                <button class="preset-button" onclick="setPrompt('Combine these two images: use the background from the first image and seamlessly integrate the subject from the second image, maintaining the exact appearance and characteristics of the subject while matching the scene\'s lighting.')">Seamless Integration</button>
                <button class="preset-button" onclick="setPrompt('Place the foreground subject in the background and adjust the lighting to match the scene')">Match Lighting</button>
            </div>
            <textarea id="promptInput" class="prompt-input" placeholder="Describe how you want to blend the foreground subject into the background...">Create a new image by combining the elements from the provided images. Take the dog from the second image and place it naturally into the scene from the first image. Ensure that the dog's features remain completely unchanged while blending seamlessly with the background lighting and atmosphere.</textarea>
        </div>
        
        <div>
            <button class="button" id="processButton" onclick="processImages()" disabled>üöÄ Blend Images</button>
        </div>
        
        <div id="resultArea" class="result-area" style="display: none;">
            <h3>Result:</h3>
            <div id="resultContent"></div>
        </div>
    </div>

    <script>
        let backgroundImage = null;
        let foregroundImage = null;
        
        // Upload area handling
        const backgroundUploadArea = document.getElementById('backgroundUploadArea');
        const foregroundUploadArea = document.getElementById('foregroundUploadArea');
        const backgroundInput = document.getElementById('backgroundInput');
        const foregroundInput = document.getElementById('foregroundInput');
        const backgroundPreview = document.getElementById('backgroundPreview');
        const foregroundPreview = document.getElementById('foregroundPreview');
        const processButton = document.getElementById('processButton');
        const promptInput = document.getElementById('promptInput');
        const resultArea = document.getElementById('resultArea');
        const resultContent = document.getElementById('resultContent');
        
        // Background upload setup
        backgroundUploadArea.addEventListener('click', () => backgroundInput.click());
        backgroundUploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            backgroundUploadArea.classList.add('dragover');
        });
        backgroundUploadArea.addEventListener('dragleave', () => {
            backgroundUploadArea.classList.remove('dragover');
        });
        backgroundUploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            backgroundUploadArea.classList.remove('dragover');
            if (e.dataTransfer.files.length > 0) {
                handleBackgroundFile(e.dataTransfer.files[0]);
            }
        });
        backgroundInput.addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                handleBackgroundFile(e.target.files[0]);
            }
        });
        
        // Foreground upload setup
        foregroundUploadArea.addEventListener('click', () => foregroundInput.click());
        foregroundUploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            foregroundUploadArea.classList.add('dragover');
        });
        foregroundUploadArea.addEventListener('dragleave', () => {
            foregroundUploadArea.classList.remove('dragover');
        });
        foregroundUploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            foregroundUploadArea.classList.remove('dragover');
            if (e.dataTransfer.files.length > 0) {
                handleForegroundFile(e.dataTransfer.files[0]);
            }
        });
        foregroundInput.addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                handleForegroundFile(e.target.files[0]);
            }
        });
        
        function handleBackgroundFile(file) {
            if (file.type.startsWith('image/')) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    backgroundImage = {
                        name: file.name,
                        data: e.target.result,
                        mimeType: file.type
                    };
                    displayBackgroundImage();
                    updateProcessButton();
                };
                reader.readAsDataURL(file);
            }
        }
        
        function handleForegroundFile(file) {
            if (file.type.startsWith('image/')) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    foregroundImage = {
                        name: file.name,
                        data: e.target.result,
                        mimeType: file.type
                    };
                    displayForegroundImage();
                    updateProcessButton();
                };
                reader.readAsDataURL(file);
            }
        }
        
        function displayBackgroundImage() {
            backgroundPreview.innerHTML = `
                <img src="${backgroundImage.data}" class="image-preview" alt="${backgroundImage.name}">
                <br>
                <small>üì∑ ${backgroundImage.name}</small>
                <button onclick="removeBackgroundImage()" style="position: absolute; top: 5px; right: 5px; background: red; color: white; border: none; border-radius: 50%; width: 25px; height: 25px; cursor: pointer;">√ó</button>
            `;
            backgroundPreview.style.position = 'relative';
        }
        
        function displayForegroundImage() {
            foregroundPreview.innerHTML = `
                <img src="${foregroundImage.data}" class="image-preview" alt="${foregroundImage.name}">
                <br>
                <small>üéØ ${foregroundImage.name}</small>
                <button onclick="removeForegroundImage()" style="position: absolute; top: 5px; right: 5px; background: red; color: white; border: none; border-radius: 50%; width: 25px; height: 25px; cursor: pointer;">√ó</button>
            `;
            foregroundPreview.style.position = 'relative';
        }
        
        function removeBackgroundImage() {
            backgroundImage = null;
            backgroundPreview.innerHTML = '';
            updateProcessButton();
        }
        
        function removeForegroundImage() {
            foregroundImage = null;
            foregroundPreview.innerHTML = '';
            updateProcessButton();
        }
        
        function updateProcessButton() {
            processButton.disabled = !backgroundImage || !foregroundImage || !promptInput.value.trim();
        }
        
        function setPrompt(text) {
            promptInput.value = text;
            updateProcessButton();
        }
        
        promptInput.addEventListener('input', updateProcessButton);
        
        async function processImages() {
            if (!backgroundImage || !foregroundImage || !promptInput.value.trim()) return;
            
            processButton.disabled = true;
            resultArea.style.display = 'block';
            resultContent.innerHTML = '<div class="loading"><div class="spinner"></div>Blending images with Gemini AI (multi-image mode)...</div>';
            
            try {
                const prompt = promptInput.value.trim();
                
                // Send both images to the API
                const backgroundData = backgroundImage.data.split(',')[1];
                const foregroundData = foregroundImage.data.split(',')[1];
                
                const response = await fetch('/.netlify/functions/gemini-image', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        model: 'gemini-2.5-flash-image-preview',
                        prompt: prompt,
                        imageData: backgroundData,
                        mimeType: backgroundImage.mimeType,
                        foregroundImageData: foregroundData,
                        foregroundMimeType: foregroundImage.mimeType
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                
                if (data.result.startsWith('data:image/')) {
                    resultContent.innerHTML = `
                        <img src="${data.result}" style="max-width: 100%; border-radius: 8px;">
                        <br><br>
                        <button class="button" onclick="downloadResult('${data.result}')">üíæ Download Result</button>
                    `;
                } else {
                    resultContent.innerHTML = `<p>${data.result}</p>`;
                }
                
            } catch (error) {
                console.error('Error:', error);
                resultContent.innerHTML = `<p style="color: red;">Error: ${error.message}</p>`;
            }
            
            processButton.disabled = false;
        }
        
        function downloadResult(dataUrl) {
            const link = document.createElement('a');
            link.href = dataUrl;
            link.download = 'blended-image.png';
            link.click();
        }
    </script>
</body>
</html>
