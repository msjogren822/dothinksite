<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Dogify Your Photo</title>
  <link rel="stylesheet" href="/assets/css/dogify.css">
</head>
<body>
  <h1>$dog-ify Your Photo</h1>
  <p>Capture your selfie and let AI add $dog to your scene!</p>

  <button id="start-camera" class="regular-button">üì∑ Start Camera</button>

  <!-- Camera view with side buttons -->
  <div class="camera-container">
    <button id="capture-left" class="side-button" style="display: none;">
      üì∏
      <div class="vertical-text">CAPTURE</div>
    </button>
    
    <video id="video" autoplay playsinline style="display: none;"></video>
    <canvas id="canvas" style="display: none;"></canvas>
    
    <button id="capture-right" class="side-button" style="display: none;">
      üì∏
      <div class="vertical-text">CAPTURE</div>
    </button>
  </div>

  <!-- Dogify buttons (same layout) -->
  <div class="camera-container" id="dogify-container" style="display: none;">
    <button id="dogify-left" class="side-button" disabled>
      üêï
      <div class="vertical-text">ADD $DOG</div>
    </button>
    
    <div style="width: 300px; height: 20px;"></div> <!-- Spacer to maintain alignment -->
    
    <button id="dogify-right" class="side-button" disabled>
      üêï
      <div class="vertical-text">ADD $DOG</div>
    </button>
  </div>

  <div id="status"></div>
  <img id="dogified-image" alt="AI Generated Image" style="display: none;" />

  <!-- Technical Details Accordion -->
  <div id="tech-details" class="accordion" style="display: none;">
    <div class="accordion-header" onclick="toggleAccordion()">
      <span class="accordion-toggle">‚ñ∂</span>
      <span>Technical Details</span>
    </div>
    <div class="accordion-content">
      <div class="accordion-section">
        <h4>What AI Saw:</h4>
        <div class="content-box" id="scene-analysis"></div>
      </div>
      <div class="accordion-section">
        <h4>Generation Prompt Used:</h4>
        <div class="content-box" id="generation-prompt"></div>
      </div>
    </div>
  </div>

  <script>
    const startCameraBtn = document.getElementById('start-camera');
    const video = document.getElementById('video');
    const canvas = document.getElementById('canvas');
    const captureLeftBtn = document.getElementById('capture-left');
    const captureRightBtn = document.getElementById('capture-right');
    const dogifyLeftBtn = document.getElementById('dogify-left');
    const dogifyRightBtn = document.getElementById('dogify-right');
    const dogifyContainer = document.getElementById('dogify-container');
    const statusEl = document.getElementById('status');
    const dogifiedImgEl = document.getElementById('dogified-image');
    const techDetails = document.getElementById('tech-details');
    const sceneAnalysisEl = document.getElementById('scene-analysis');
    const generationPromptEl = document.getElementById('generation-prompt');

    const specialDogURL = '/assets/images/special_dog.png';

    let stream = null;
    let capturedImageData = '';

    // Accordion toggle function
    function toggleAccordion() {
      const content = document.querySelector('.accordion-content');
      const toggle = document.querySelector('.accordion-toggle');
      
      content.classList.toggle('expanded');
      toggle.classList.toggle('expanded');
    }

    // Start the webcam
    startCameraBtn.addEventListener('click', async () => {
      try {
        startCameraBtn.classList.add('button-active');
        startCameraBtn.innerHTML = 'üîÑ Starting Camera...';
        startCameraBtn.disabled = true;
        
        stream = await navigator.mediaDevices.getUserMedia({ video: true });
        video.srcObject = stream;
        video.style.display = 'block';
        
        // Show side capture buttons with glow effect
        captureLeftBtn.style.display = 'flex';
        captureRightBtn.style.display = 'flex';
        captureLeftBtn.classList.add('button-capture');
        captureRightBtn.classList.add('button-capture');
        startCameraBtn.style.display = 'none';
        
        statusEl.innerHTML = 'üìπ <strong>Camera ready!</strong> Tap either capture button when ready.';
        
      } catch (err) {
        startCameraBtn.classList.remove('button-active');
        startCameraBtn.innerHTML = 'üì∑ Start Camera';
        startCameraBtn.disabled = false;
        statusEl.innerHTML = `üö® Camera error: ${err.message}`;
      }
    });

    // Capture function for both buttons
    function capturePhoto() {
      captureLeftBtn.classList.remove('button-capture');
      captureRightBtn.classList.remove('button-capture');
      captureLeftBtn.classList.add('button-active');
      captureRightBtn.classList.add('button-active');
      
      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;
      canvas.getContext('2d').drawImage(video, 0, 0);
      capturedImageData = canvas.toDataURL('image/png', 0.8);
      
      canvas.style.display = 'block';
      video.style.display = 'none';
      captureLeftBtn.style.display = 'none';
      captureRightBtn.style.display = 'none';
      
      // Show dogify buttons container
      dogifyContainer.style.display = 'flex';
      dogifyLeftBtn.disabled = false;
      dogifyRightBtn.disabled = false;
      dogifyLeftBtn.classList.add('button-capture');
      dogifyRightBtn.classList.add('button-capture');
      
      if (stream) {
        stream.getTracks().forEach(track => track.stop());
      }
      
      statusEl.innerHTML = 'üì∏ <strong>Photo captured!</strong> Now tap either button to add $dog!';
    }

    // Add capture listeners to both buttons
    captureLeftBtn.addEventListener('click', capturePhoto);
    captureRightBtn.addEventListener('click', capturePhoto);

    // Fetch an image and convert it to a data URL
    async function fetchImageAsDataURL(url) {
      const response = await fetch(url);
      const blob = await response.blob();
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onloadend = () => resolve(reader.result);
        reader.onerror = reject;
        reader.readAsDataURL(blob);
      });
    }

    // Dogify function for both buttons
    async function dogifyPhoto() {
      try {
        dogifyLeftBtn.classList.remove('button-capture');
        dogifyRightBtn.classList.remove('button-capture');
        dogifyLeftBtn.classList.add('button-active');
        dogifyRightBtn.classList.add('button-active');
        dogifyLeftBtn.disabled = true;
        dogifyRightBtn.disabled = true;
        
        const functionName = 'venice-dogify';
        
        let seconds = 0;
        const counterInterval = setInterval(() => {
          seconds++;
          const dots = '.'.repeat((seconds % 4));
          
          if (seconds <= 8) {
            statusEl.innerHTML = `üîç Analyzing your selfie${dots}<br><small>Using Venice.ai | ${seconds}s elapsed</small>`;
          } else {
            statusEl.innerHTML = `üêï Adding $dog ${dots}<br><small>Using Venice.ai | ${seconds}s elapsed</small>`;
          }
        }, 1000);
        
        const dogImageData = await fetchImageAsDataURL(specialDogURL);
        
        const response = await fetch(`/.netlify/functions/${functionName}`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            userImage: capturedImageData,
            dogImage: dogImageData,
            model: 'venice'
          })
        });

        clearInterval(counterInterval);

        if (!response.ok) {
          const text = await response.text();
          console.error('Server response:', text);
          throw new Error(`Server error: ${response.status}`);
        }

        const result = await response.json();
        if (!result.ok) throw new Error(result.error);

        dogifiedImgEl.src = result.generatedImageUrl;
        dogifiedImgEl.style.display = 'block';
        
        dogifyLeftBtn.style.background = '#28a745';
        dogifyRightBtn.style.background = '#28a745';
        
        // Populate technical details
        sceneAnalysisEl.textContent = result.sceneAnalysis || result.imageAnalysis || 'No analysis available';
        generationPromptEl.textContent = result.placementPrompt || result.reproductionPrompt || 'No prompt available';
        techDetails.style.display = 'block';
        
        statusEl.innerHTML = `
          ‚ú® <strong>$dog Added!</strong> (${seconds}s)<br>
          <small>Using ${result.visionModel || result.model} | Refresh to try again</small>
        `;
        
      } catch (err) {
        console.error('$dogify error:', err);
        statusEl.innerHTML = `üö® <strong>Error:</strong> ${err.message}<br><small>Try refreshing to capture a new photo</small>`;
        dogifyLeftBtn.style.background = '#dc3545';
        dogifyRightBtn.style.background = '#dc3545';
      }
    }

    // Add dogify listeners to both buttons
    dogifyLeftBtn.addEventListener('click', dogifyPhoto);
    dogifyRightBtn.addEventListener('click', dogifyPhoto);
  </script>

  <div class="powered-by">
    <span class="powered-by-text">Powered by</span>
    <img src="/assets/images/venice-logo-lockup-black.svg" alt="Venice.ai" class="venice-logo" />
  </div>
</body>
</html>
