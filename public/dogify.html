<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Dogify Your Photo</title>
  <style>
    body {
      font-family: system-ui, -apple-system, sans-serif;
      padding: 2rem;
      max-width: 800px;
      margin: 0 auto;
      line-height: 1.5;
    }
    button {
      padding: 0.75rem 1.5rem;
      font-size: 1.1rem;
      cursor: pointer;
      background: #0070f3;
      color: white;
      border: none;
      border-radius: 8px;
      transition: all 0.2s ease;
      min-height: 50px;
      font-weight: 600;
    }
    button:hover {
      background: #0051b3;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0,112,243,0.3);
    }
    button:active {
      transform: translateY(0);
      box-shadow: 0 2px 6px rgba(0,112,243,0.3);
    }
    button:disabled {
      background: #ccc;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }
    .button-active {
      background: #28a745 !important;
      animation: pulse 0.6s;
    }
    .button-capture {
      background: #ff6b35 !important;
      animation: glow 1s infinite;
    }
    @keyframes pulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.05); }
      100% { transform: scale(1); }
    }
    @keyframes glow {
      0%, 100% { box-shadow: 0 0 5px #ff6b35; }
      50% { box-shadow: 0 0 20px #ff6b35, 0 0 30px #ff6b35; }
    }
    select {
      padding: 0.5rem;
      font-size: 1rem;
      border: 1px solid #ccc;
      border-radius: 4px;
      margin: 0.5rem 0;
    }
    .model-selector {
      background: #f8f9fa;
      padding: 1rem;
      border-radius: 8px;
      margin: 1rem 0;
    }
    #status {
      margin: 1rem 0;
      padding: 0.5rem;
      border-radius: 4px;
      background: #f5f5f5;
    }
    video, canvas, img {
      max-width: 100%;
      height: auto;
      margin: 1rem 0;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
  </style>
</head>
<body>
  <h1>$dog-ify Your Photo</h1>
  <p>Capture your selfie and let AI add $dog to your scene!</p>

  <div class="model-selector">
    <label for="ai-model"><strong>Choose AI Model:</strong></label><br>
    <select id="ai-model">
      <option value="openai">OpenAI (preserves background only)</option>
      <option value="venice">Venice.ai (preserves people + background)</option>
    </select>
    <p><small>
      <strong>OpenAI:</strong> Great for background scenes, removes people for privacy<br>
      <strong>Venice.ai:</strong> Preserves people in selfies, better for personal photos
    </small></p>
  </div>

  <button id="start-camera">üì∑ Start Camera</button>
  <video id="video" autoplay playsinline style="display: none;"></video>
  <button id="capture-btn" style="display: none;">üì∏ Capture Photo</button>
  <canvas id="canvas" style="display: none;"></canvas>

  <button id="dogify-btn" disabled style="display: none;">üêï Add $dog!</button>

  <div id="status"></div>
  <img id="dogified-image" alt="AI Generated Image" style="display: none;" />

  <script>
    const startCameraBtn = document.getElementById('start-camera');
    const video = document.getElementById('video');
    const canvas = document.getElementById('canvas');
    const captureBtn = document.getElementById('capture-btn');
    const dogifyBtn = document.getElementById('dogify-btn');
    const statusEl = document.getElementById('status');
    const dogifiedImgEl = document.getElementById('dogified-image');
    const aiModelSelect = document.getElementById('ai-model');

    // Update this path to wherever you host your special dog image
    const specialDogURL = '/assets/images/special_dog.png';

    let stream = null;
    let capturedImageData = '';

    // Start the webcam with lively feedback
    startCameraBtn.addEventListener('click', async () => {
      try {
        // Immediate visual feedback
        startCameraBtn.classList.add('button-active');
        startCameraBtn.innerHTML = 'üîÑ Starting Camera...';
        startCameraBtn.disabled = true;
        
        stream = await navigator.mediaDevices.getUserMedia({ video: true });
        video.srcObject = stream;
        video.style.display = 'block';
        
        // Show capture button with glow effect
        captureBtn.style.display = 'block';
        captureBtn.classList.add('button-capture');
        startCameraBtn.style.display = 'none';
        
        statusEl.innerHTML = 'üìπ <strong>Camera ready!</strong> Position yourself and tap the glowing button to capture.';
        
      } catch (err) {
        startCameraBtn.classList.remove('button-active');
        startCameraBtn.innerHTML = 'üì∑ Start Camera';
        startCameraBtn.disabled = false;
        statusEl.innerHTML = `üö® Camera error: ${err.message}`;
      }
    });

    // Capture a frame with immediate feedback
    captureBtn.addEventListener('click', () => {
      // Immediate visual feedback
      captureBtn.classList.remove('button-capture');
      captureBtn.classList.add('button-active');
      captureBtn.innerHTML = '‚ú® Captured!';
      captureBtn.disabled = true;
      
      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;
      canvas.getContext('2d').drawImage(video, 0, 0);
      capturedImageData = canvas.toDataURL('image/png', 0.8);
      
      canvas.style.display = 'block';
      dogifyBtn.style.display = 'block';
      dogifyBtn.disabled = false;
      dogifyBtn.classList.add('button-capture'); // Make it glow too
      
      video.style.display = 'none';
      captureBtn.style.display = 'none';
      
      if (stream) {
        stream.getTracks().forEach(track => track.stop());
      }
      
      statusEl.innerHTML = 'üì∏ <strong>Photo captured!</strong> Now tap the glowing button to add your dog companion!';
    });

    // Fetch an image and convert it to a data URL
    async function fetchImageAsDataURL(url) {
      const response = await fetch(url);
      const blob = await response.blob();
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onloadend = () => resolve(reader.result);
        reader.onerror = reject;
        reader.readAsDataURL(blob);
      });
    }

    // Add dog companion
    dogifyBtn.addEventListener('click', async () => {
      try {
        // Immediate feedback
        dogifyBtn.classList.remove('button-capture');
        dogifyBtn.classList.add('button-active');
        dogifyBtn.innerHTML = 'üöÄ Processing...';
        dogifyBtn.disabled = true;
        
        const selectedModel = aiModelSelect.value;
        const functionName = selectedModel === 'venice' ? 'venice-dogify' : 'openai-dogify';
        
        let seconds = 0;
        const maxSeconds = 25;
        
        // Start the counter
        const counterInterval = setInterval(() => {
          seconds++;
          const dots = '.'.repeat((seconds % 4));
          
          if (seconds <= 8) {
            statusEl.innerHTML = `üîç Analyzing your ${selectedModel === 'venice' ? 'selfie' : 'scene'}${dots}<br><small>Using ${selectedModel.toUpperCase()} | ${seconds}s elapsed</small>`;
          } else {
            statusEl.innerHTML = `üêï Adding $dog ${dots}<br><small>Using ${selectedModel.toUpperCase()} | ${seconds}s elapsed</small>`;
          }
        }, 1000);
        
        // Fetch the special dog image
        const dogImageData = await fetchImageAsDataURL(specialDogURL);
        
        const response = await fetch(`/.netlify/functions/${functionName}`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            userImage: capturedImageData,
            dogImage: dogImageData,
            model: selectedModel
          })
        });

        clearInterval(counterInterval);

        if (!response.ok) {
          const text = await response.text();
          console.error('Server response:', text);
          throw new Error(`Server error: ${response.status}`);
        }

        const result = await response.json();
        if (!result.ok) throw new Error(result.error);

        // Display the result
        dogifiedImgEl.src = result.generatedImageUrl;
        dogifiedImgEl.style.display = 'block';
        
        // Success feedback
        dogifyBtn.innerHTML = '‚úÖ Success!';
        dogifyBtn.style.background = '#28a745';
        
        statusEl.innerHTML = `
          ‚ú® <strong>$dog Added!</strong> (${seconds}s)<br><br>
          <strong>Model:</strong> ${result.visionModel || result.model}<br><br>
          <strong>What AI saw:</strong><br>
          <div style="background: #fff; padding: 10px; border: 1px solid #ccc; border-radius: 4px; margin: 10px 0; font-family: monospace; font-size: 12px; max-height: 200px; overflow-y: auto;">
            ${result.sceneAnalysis || result.imageAnalysis}
          </div>
          <strong>Placement prompt:</strong><br>
          <div style="background: #f0f8ff; padding: 10px; border: 1px solid #ccc; border-radius: 4px; margin: 10px 0; font-family: monospace; font-size: 12px;">
            ${result.placementPrompt || result.reproductionPrompt}
          </div>
          <em>Refresh to try again!</em>
        `;
        
      } catch (err) {
        console.error('$dogify error:', err);
        statusEl.innerHTML = `üö® <strong>Error:</strong> ${err.message}<br><small>Try switching models or refresh to capture a new photo</small>`;
        dogifyBtn.innerHTML = '‚ùå Failed';
        dogifyBtn.style.background = '#dc3545';
      } finally {
        setTimeout(() => {
          dogifyBtn.disabled = false;
          dogifyBtn.classList.remove('button-active');
        }, 2000);
      }
    });
  </script>
</body>
</html>
