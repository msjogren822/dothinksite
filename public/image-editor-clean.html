<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Image Editor with Gemini AI</title>
    <style>
        body {
            font-family: 'Google Sans', Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background: #f8f9fa;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .upload-area {
            border: 2px dashed #4285f4;
            border-radius: 8px;
            padding: 40px;
            text-align: center;
            margin: 20px 0;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .upload-area:hover {
            background: #f1f3f4;
        }
        .upload-area.dragover {
            border-color: #1a73e8;
            background: #e8f0fe;
        }
        .image-preview {
            max-width: 100%;
            max-height: 300px;
            margin: 10px 0;
            border-radius: 8px;
        }
        .button {
            background: #1a73e8;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            margin: 10px 5px;
        }
        .button:hover {
            background: #1557b0;
        }
        .button:disabled {
            background: #dadce0;
            cursor: not-allowed;
        }
        .prompt-input {
            width: 100%;
            padding: 12px;
            border: 1px solid #dadce0;
            border-radius: 6px;
            font-size: 14px;
            margin: 10px 0;
            min-height: 60px;
            resize: vertical;
        }
        .result-area {
            margin-top: 20px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
        }
        .loading {
            display: flex;
            align-items: center;
            gap: 10px;
            color: #5f6368;
        }
        .spinner {
            width: 20px;
            height: 20px;
            border: 2px solid #f3f3f3;
            border-top: 2px solid #4285f4;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .preset-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin: 15px 0;
        }
        .preset-button {
            background: #f1f3f4;
            color: #3c4043;
            border: 1px solid #dadce0;
            padding: 8px 16px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 13px;
        }
        .preset-button:hover {
            background: #e8eaed;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üé® Image Editor with Gemini AI</h1>
        <p>Upload a background and foreground image to blend them together with AI!</p>
        
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin: 20px 0;">
            <div>
                <h3>üì∑ Background Image</h3>
                <div class="upload-area" id="backgroundUploadArea">
                    <div>üñºÔ∏è Drop background image here</div>
                    <input type="file" id="backgroundInput" accept="image/*" style="display: none;">
                </div>
                <div id="backgroundPreview"></div>
            </div>
            
            <div>
                <h3>üéØ Foreground Subject</h3>
                <div class="upload-area" id="foregroundUploadArea">
                    <div>üë§ Drop foreground subject here</div>
                    <input type="file" id="foregroundInput" accept="image/*" style="display: none;">
                </div>
                <div id="foregroundPreview"></div>
            </div>
        </div>
        
        <div>
            <h3>üîß Blending Approach</h3>
            <div class="preset-buttons">
                <button class="preset-button" onclick="setPrompt('Using the provided images, add the subject from the second image into this scene. Match the lighting, shadows, and atmosphere so the subject appears to naturally belong in this environment.')">Direct Integration</button>
                <button class="preset-button" onclick="setPrompt('Transform both images to have the same style and lighting, then seamlessly blend the subject into the background scene.')">Style-First Blend</button>
                <button class="preset-button" onclick="setPrompt('Using the provided images, change only the background to include the subject from the second image. Keep the background scene exactly the same but add the subject with matching perspective and lighting.')">Inpainting Add</button>
                <button class="preset-button" onclick="setPrompt('Step 1: Apply cartoon style to both images. Step 2: Blend the cartoon subject into the cartoon background scene maintaining consistent art style throughout.')">Step-by-Step</button>
            </div>
            
            <h3>üé® Style Transform</h3>
            <div style="margin: 15px 0; display: flex; flex-wrap: wrap; align-items: center; gap: 10px;">
                <div>
                    <label for="styleSelect" style="display: block; margin-bottom: 8px; font-weight: bold;">Choose Art Style:</label>
                    <select id="styleSelect" style="padding: 8px; border: 1px solid #dadce0; border-radius: 6px; font-size: 14px; margin-right: 10px; min-width: 220px;">
                        <option value="cartoon">Cartoon</option>
                        <option value="bauhaus">Bauhaus</option>
                        <option value="impressionist">Impressionist</option>
                        <option value="cubist">Cubist</option>
                        <option value="art_deco">Art Deco</option>
                        <option value="watercolor">Watercolor</option>
                        <option value="oil_painting">Oil Painting (impasto)</option>
                        <option value="cyberpunk">Cyberpunk</option>
                        <option value="minimalist">Minimalist</option>
                        <option value="vintage_poster">Vintage Poster</option>
                    </select>
                </div>
                <label style="display: inline-flex; align-items: center; gap: 8px; user-select: none;">
                    <input type="checkbox" id="enforceStyle" checked>
                    <span>Force strong style, suppress photorealism</span>
                </label>
                <button class="preset-button" onclick="setStylePrompt()" style="background: #1a73e8; color: white; padding: 8px 16px;">üé® Apply Style Transform</button>
            </div>
            
            <h3>üé≠ Advanced Techniques</h3>
            <div class="preset-buttons">
                <button class="preset-button" onclick="setPrompt('Using inpainting technique: Keep the background from the first image exactly as is, but seamlessly add the subject from the second image to appear naturally within the scene, matching all lighting and atmospheric conditions.')">üéØ Inpainting Mode</button>
                <button class="preset-button" onclick="setPrompt('Apply semantic masking: Transform only the area where the subject will be placed in the first image to accommodate the subject from the second image, blending the edges perfectly while preserving the rest of the scene.')">üé≠ Semantic Mask</button>
            </div>

            <div style="margin-top: 10px; display: flex; align-items: center; gap: 10px;">
                <label style="display: inline-flex; align-items: center; gap: 8px; user-select: none;">
                    <input type="checkbox" id="useTwoPass" checked>
                    <span>Use two-pass stylize ‚Üí blend pipeline</span>
                </label>
            </div>
            
            <textarea id="promptInput" class="prompt-input" placeholder="Describe your blending approach...">Transform both provided images into vibrant cartoon style, then combine them: place the cartoon subject from the second image into the cartoon background from the first image with unified cartoon aesthetics.</textarea>
        </div>
        
        <div>
            <button class="button" id="processButton" onclick="processImages()" disabled>üöÄ Blend Images</button>
        </div>
        
        <div id="resultArea" class="result-area" style="display: none;">
            <h3>Result:</h3>
            <div id="resultContent"></div>
        </div>
    </div>

    <script>
        let backgroundImage = null;
        let foregroundImage = null;
        
        // Upload area handling
        const backgroundUploadArea = document.getElementById('backgroundUploadArea');
        const foregroundUploadArea = document.getElementById('foregroundUploadArea');
        const backgroundInput = document.getElementById('backgroundInput');
        const foregroundInput = document.getElementById('foregroundInput');
        const backgroundPreview = document.getElementById('backgroundPreview');
        const foregroundPreview = document.getElementById('foregroundPreview');
        const processButton = document.getElementById('processButton');
        const promptInput = document.getElementById('promptInput');
        const resultArea = document.getElementById('resultArea');
        const resultContent = document.getElementById('resultContent');
        
        // Background upload setup
        backgroundUploadArea.addEventListener('click', () => backgroundInput.click());
        backgroundUploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            backgroundUploadArea.classList.add('dragover');
        });
        backgroundUploadArea.addEventListener('dragleave', () => {
            backgroundUploadArea.classList.remove('dragover');
        });
        backgroundUploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            backgroundUploadArea.classList.remove('dragover');
            if (e.dataTransfer.files.length > 0) {
                handleBackgroundFile(e.dataTransfer.files[0]);
            }
        });
        backgroundInput.addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                handleBackgroundFile(e.target.files[0]);
            }
        });
        
        // Foreground upload setup
        foregroundUploadArea.addEventListener('click', () => foregroundInput.click());
        foregroundUploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            foregroundUploadArea.classList.add('dragover');
        });
        foregroundUploadArea.addEventListener('dragleave', () => {
            foregroundUploadArea.classList.remove('dragover');
        });
        foregroundUploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            foregroundUploadArea.classList.remove('dragover');
            if (e.dataTransfer.files.length > 0) {
                handleForegroundFile(e.dataTransfer.files[0]);
            }
        });
        foregroundInput.addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                handleForegroundFile(e.target.files[0]);
            }
        });
        
        async function downscaleImageToDataURL(dataUrl, maxDim = 1280, quality = 0.9) {
            try {
                const img = new Image();
                img.crossOrigin = 'anonymous';
                const loaded = new Promise((res, rej) => { img.onload = () => res(); img.onerror = rej; });
                img.src = dataUrl;
                await loaded;
                const scale = Math.min(1, maxDim / Math.max(img.width, img.height));
                const w = Math.max(1, Math.round(img.width * scale));
                const h = Math.max(1, Math.round(img.height * scale));
                const canvas = document.createElement('canvas');
                canvas.width = w; canvas.height = h;
                const ctx = canvas.getContext('2d');
                ctx.imageSmoothingQuality = 'high';
                ctx.drawImage(img, 0, 0, w, h);
                // Keep original mime when possible
                const type = dataUrl.startsWith('data:image/png') ? 'image/png' : 'image/jpeg';
                return canvas.toDataURL(type, quality);
            } catch {
                return dataUrl; // fallback
            }
        }

        function handleBackgroundFile(file) {
            if (file.type.startsWith('image/')) {
                const reader = new FileReader();
                reader.onload = async (e) => {
                    const raw = e.target.result;
                    const ds = await downscaleImageToDataURL(raw);
                    backgroundImage = { name: file.name, data: ds, mimeType: file.type };
                    displayBackgroundImage();
                    updateProcessButton();
                };
                reader.readAsDataURL(file);
            }
        }
        
        function handleForegroundFile(file) {
            if (file.type.startsWith('image/')) {
                const reader = new FileReader();
                reader.onload = async (e) => {
                    const raw = e.target.result;
                    const ds = await downscaleImageToDataURL(raw);
                    foregroundImage = { name: file.name, data: ds, mimeType: file.type };
                    displayForegroundImage();
                    updateProcessButton();
                };
                reader.readAsDataURL(file);
            }
        }
        
        function displayBackgroundImage() {
            backgroundPreview.innerHTML = `
                <img src="${backgroundImage.data}" class="image-preview" alt="${backgroundImage.name}">
                <br>
                <small>üì∑ ${backgroundImage.name}</small>
                <button onclick="removeBackgroundImage()" style="position: absolute; top: 5px; right: 5px; background: red; color: white; border: none; border-radius: 50%; width: 25px; height: 25px; cursor: pointer;">√ó</button>
            `;
            backgroundPreview.style.position = 'relative';
        }
        
        function displayForegroundImage() {
            foregroundPreview.innerHTML = `
                <img src="${foregroundImage.data}" class="image-preview" alt="${foregroundImage.name}">
                <br>
                <small>üéØ ${foregroundImage.name}</small>
                <button onclick="removeForegroundImage()" style="position: absolute; top: 5px; right: 5px; background: red; color: white; border: none; border-radius: 50%; width: 25px; height: 25px; cursor: pointer;">√ó</button>
            `;
            foregroundPreview.style.position = 'relative';
        }
        
        function removeBackgroundImage() {
            backgroundImage = null;
            backgroundPreview.innerHTML = '';
            updateProcessButton();
        }
        
        function removeForegroundImage() {
            foregroundImage = null;
            foregroundPreview.innerHTML = '';
            updateProcessButton();
        }
        
        function updateProcessButton() {
            processButton.disabled = !backgroundImage || !foregroundImage || !promptInput.value.trim();
        }
        
        function setPrompt(text) {
            promptInput.value = text;
            updateProcessButton();
        }
        
        function setStylePrompt() {
            const styleSelect = document.getElementById('styleSelect');
            const enforce = document.getElementById('enforceStyle')?.checked;
            const key = styleSelect.value;

            // map style keys to user-facing style words and rendering instructions
            const styles = {
                cartoon: {
                    label: 'cartoon',
                    render: 'simplified forms, flat colors, bold outlines, limited shading, high contrast blocks, no photorealistic detail'
                },
                bauhaus: {
                    label: 'bauhaus',
                    render: 'geometric abstraction, primary colors (red, yellow, blue), black and white accents, strong composition, minimal detail'
                },
                impressionist: {
                    label: 'impressionist',
                    render: 'visible broken brushstrokes, soft edges, atmospheric perspective, emphasis on light and color over detail'
                },
                cubist: {
                    label: 'cubist',
                    render: 'faceted planes, geometric decomposition, multiple viewpoints, limited palette, strong angular edges'
                },
                art_deco: {
                    label: 'art deco',
                    render: 'streamlined forms, metallic accents, bold geometric patterns, poster-like simplification, limited gradients'
                },
                watercolor: {
                    label: 'watercolor',
                    render: 'soft washes, bleeding edges, paper texture, translucent layers, low micro-detail, no hard specular highlights'
                },
                oil_painting: {
                    label: 'oil painting',
                    render: 'heavy impasto texture, thick palette-knife strokes, visible brushwork, layered paint buildup, classical pigment mixing'
                },
                cyberpunk: {
                    label: 'cyberpunk',
                    render: 'neon rim lighting, chromatic aberration, scanlines, gritty film grain, saturated magenta-cyan highlights'
                },
                minimalist: {
                    label: 'minimalist',
                    render: 'radically simplified shapes, few colors, strong negative space, flat shading, no texture detail'
                },
                vintage_poster: {
                    label: 'vintage poster',
                    render: 'halftone or lithograph texture, limited color inks, bold typography feel, flattened perspective, paper grain'
                }
            };

            const s = styles[key] || styles.cartoon;

            const base = `Transform both provided images into ${s.label} style, then combine them: place the ${s.label} subject from the second image into the ${s.label} background from the first image with unified ${s.label} aesthetics.`;
            const cues = ` Render both elements with ${s.render}.`;
            const antiPhoto = enforce ? ' Strictly avoid photorealistic rendering, photographic textures, lens blur/bokeh, high-frequency micro-detail, or natural camera lighting.' : '';
            const unify = ' Ensure the subject and background share the exact same style, palette, and material treatment so they appear created as one artwork.';

            const prompt = base + cues + antiPhoto + ' ' + unify;
            setPrompt(prompt);
        }
        
        promptInput.addEventListener('input', updateProcessButton);
        
        async function processImages() {
            if (!backgroundImage || !foregroundImage || !promptInput.value.trim()) return;
            
            processButton.disabled = true;
            resultArea.style.display = 'block';
            const twoPass = document.getElementById('useTwoPass')?.checked;
            resultContent.innerHTML = `<div class="loading"><div class="spinner"></div>${twoPass ? 'Stylizing both images then blending‚Ä¶' : 'Blending images with Gemini AI (multi-image mode)‚Ä¶'}</div>`;
            
            try {
                const prompt = promptInput.value.trim();
                
                // Send both images to the API
                const backgroundData = backgroundImage.data.split(',')[1];
                const foregroundData = foregroundImage.data.split(',')[1];
                const useTwoPass = document.getElementById('useTwoPass')?.checked;
                let response;
                if (useTwoPass) {
                    // Attempt to infer styleKey from the current prompt (simple parse of first style token)
                    const styleSelect = document.getElementById('styleSelect');
                    const styleKey = styleSelect ? styleSelect.value : 'cartoon';
                    const enforceStyle = document.getElementById('enforceStyle')?.checked ?? true;
                    response = await fetch('/.netlify/functions/gemini-stylize-blend', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            styleKey,
                            enforceStyle,
                            promptExtras: prompt,
                            imageData: backgroundImage.data,
                            mimeType: backgroundImage.mimeType,
                            foregroundImageData: foregroundImage.data,
                            foregroundMimeType: foregroundImage.mimeType,
                        })
                    });
                } else {
                    response = await fetch('/.netlify/functions/gemini-image', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            model: 'gemini-2.5-flash-image-preview',
                            prompt: prompt,
                            imageData: backgroundData,
                            mimeType: backgroundImage.mimeType,
                            foregroundImageData: foregroundData,
                            foregroundMimeType: foregroundImage.mimeType
                        })
                    });
                }
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                
                if (data.result.startsWith('data:image/')) {
                    resultContent.innerHTML = `
                        <img src="${data.result}" style="max-width: 100%; border-radius: 8px;">
                        <br><br>
                        <button class="button" onclick="downloadResult('${data.result}')">üíæ Download Result</button>
                    `;
                } else {
                    resultContent.innerHTML = `<p>${data.result}</p>`;
                }
                
            } catch (error) {
                console.error('Error:', error);
                resultContent.innerHTML = `<p style="color: red;">Error: ${error.message}</p>`;
            }
            
            processButton.disabled = false;
        }
        
        function downloadResult(dataUrl) {
            const link = document.createElement('a');
            link.href = dataUrl;
            link.download = 'blended-image.png';
            link.click();
        }
    </script>
</body>
</html>
